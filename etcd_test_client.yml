
- name: Etcd | Client Auth | Verification | Client Certificate | generate
  when: "'localhost' in group_names"
  tags:
  - generate_etcd_test_client_certificate
  import_role:
    name: client-cert
  vars:
    certificate_CN: test-client
    client_cert_server_name: etcd_data
    client_cert_parent_ca_cert_file: "{{ pki_dir }}/etcd/client_auth/ca.pem"
    client_cert_parent_ca_key_file: "{{ pki_dir }}/etcd/client_auth/ca-key.pem"
    client_cert_output_dir: "{{ pki_dir }}/etcd/test_client"
  
- name: Etcd | Client Auth | Verification | Client Certificate | delete local certs
  file:
    state: absent
    path: "{{ pki_dir }}/etcd/test_client"
  when: "'localhost' in group_names"
  tags:
  - delete_etcd_test_client_certificate

- name: Etcd | Client Auth | Verification | Client Certificate | distribute
  copy:
    src: "{{ item.src }}"
    dest: "{{ ansible_env.HOME }}/{{ item.dest_filename if ('dest_filename' in item) else (item.src | basename) }}"
    mode: 0400
  with_items:
  - { src: "{{ pki_dir }}/etcd/test_client/etcd_data-client.pem", dest_filename: "test-etcd_data-client.pem" }
  - { src: "{{ pki_dir }}/etcd/test_client/etcd_data-client-key.pem", dest_filename: "test-etcd_data-client-key.pem" }
  when: "'etcd_peers' in group_names"
  tags:
  - distribute_etcd_test_client_certificate

- name: Etcd | Client Auth | Verification | Client Certificate | delete
  file:
    state: absent
    path: "{{ ansible_env.HOME }}/{{ item }}"
  with_items:
  - test-etcd_data-client.pem
  - test-etcd_data-client-key.pem
  when: "'etcd_peers' in group_names"
  tags:
  - delete_etcd_test_client_certificate


  