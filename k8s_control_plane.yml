---

- name: Kubernetes | Control Plane | API Server | Server certificate
  import_tasks: ./api_server_cert.yml
  when: "'localhost' in group_names"
  tags:
  - generate_the_api_server_cert
  
- name: Kubernetes | Control Plane | Controller Manager | Client certificate
  import_tasks: ./controller_manager_client_cert.yml
  when: "'localhost' in group_names"
  tags:
  - generate_the_controller_manager_cert

- name: Kubernetes | Control Plane | Admin user certificate 
  import_tasks: ./admin-cert.yml
  when: "'localhost' in group_names"
  tags:
  - generate_the_admin_cert

- name: Kubernetes | Control Plane | Distribute certificates
  copy:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}"
    mode: 0400
  with_items:
  - "{{ root_ca_cert_file }}"
  - "{{ root_ca_key_file }}"
  - "{{ pki_dir }}/api_server-server_cert/api-server.pem"
  - "{{ pki_dir }}/api_server-server_cert/api-server-key.pem"
  when: "'masters' in group_names"
  tags:
  - distribute_certificates


- name: Kubernetes | Control Plane | Download control plane components
  become: yes
  script: ./scripts/download_kubernetes_control_plane {{ kubernetes_version }}
  args:
    creates: /tmp/.download_kubernetes_control_plane
  when: "'masters' in group_names"
  tags:
  - download_kubernetes_control_plane

