

- name: Kubernetes | Control Plane | Controller Manager | Download
  become: yes
  script: "./scripts/download_kubernetes_component '{{ item }}' '{{ kubernetes_version }}'"
  with_items:
  - kube-controller-manager
  args:
    creates: /usr/bin/{{ item }}
  when: "'masters' in group_names"
  tags:
  - download_kubernetes_control_plane
  - download_controller_manager


- name: Kubernetes | Control Plane | API Server | Server Certificate 
  when: "'localhost' in group_names"
  tags:
  - generate_certificates
  - generate_client_certificates
  - generate_kube_controller_manager_client_certificate
  import_role:
    name: client-cert
  vars:
    client_cert_CN: "system:kube-controller-manager"
    client_cert_OU: "{{ client_cert_CN }}"
    client_cert_server_name: "api_server"
    client_cert_parent_ca_cert_file: "{{ root_ca_cert_file }}"
    client_cert_parent_ca_key_file: "{{ root_ca_key_file }}"
    client_cert_output_dir: "{{ pki_dir }}/controller_manager"


- name: Kubernetes | Control Plane | Controller Manager | Service | Create
  when: "'masters' in group_names"
  tags:
  - start_controller_manager
  become: yes
  copy: 
    dest: /etc/systemd/system/kube-controller-manager.service
    content: |
      [Unit]
      Description=Kubernetes Controller Manager
      Documentation=https://github.com/kubernetes/kubernetes

      [Service]
      ExecStart=/usr/bin/kube-controller-manager \
        --address=0.0.0.0 \
        --cluster-cidr=10.200.0.0/16 \
        --cluster-name=kubernetes \
        --cluster-signing-cert-file={{ ansible_env.HOME }}/{{ root_ca_cert_file | basename }} \
        --cluster-signing-key-file={{ ansible_env.HOME }}/{{ root_ca_key_file | basename }} \
        --leader-elect=true \
        --master=http://127.0.0.1:8080 \
        --root-ca-file={{ ansible_env.HOME }}/{{ root_ca_cert_file | basename }} \
        --service-account-private-key-file={{ ansible_env.HOME }}/{{ root_ca_key_file | basename }} \
        --service-cluster-ip-range=10.32.0.0/24 \
        --v=2
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

- name: Kubernetes | Control Plane | Controller Manager | Service | Start
  when: "'masters' in group_names"
  tags:
  - start_controller_manager
  become: yes
  systemd:
    name: kube-controller-manager
    enabled: yes
    state: started
    daemon_reload: yes
