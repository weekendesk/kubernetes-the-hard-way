

- name: Kubernetes | Control Plane | API Server | Download
  become: yes
  script: "./scripts/download_kubernetes_component '{{ item }}' '{{ kubernetes_version }}'"
  with_items:
  - kube-apiserver
  args:
    creates: /usr/bin/{{ item }}
  when: "'masters' in group_names"
  tags:
  - download_kubernetes_control_plane
  - download_api_server

- name: Kubernetes | Control Plane | API Server | Generate the server certificate
  when: "'localhost' in group_names"
  tags:
  - generate_certificates
  - generate_server_certificates
  - generate_api_server_certificate
  block:
  - name: Kubernetes | Control Plane | API Server | Server Certificate | Require the Root CA to be accessible
    block:
    - name: Kubernetes | Control Plane | API Server | Server Certificate | stat the required Root CA files
      stat:
        path: "{{ item }}"
      with_items: 
      - "{{ root_ca_cert_file }}"
      - "{{ root_ca_key_file }}"
      register: root_ca_files_stat_result

    - name: Kubernetes | Control Plane | API Server | Server Certificate | the required Root CA files must exist
      assert:
        that: "{{ root_ca_files_stat_result.results | map(attribute='stat') | list | selectattr('exists', 'sameas', true) | list | length == root_ca_files_stat_result.results | length }}"
        fail_msg: "you need to generate the Root CA in {{ root_ca_dir }}"

  - name: Kubernetes | Control Plane | API Server | Server Certificate | create the work directories
    file:
      path: "{{ pki_dir }}/api_server-server_cert"
      state: directory
      recurse: yes

  - name: Kubernetes | Control Plane | API Server | Server Certificate | build the signing configuration
    copy:
      dest: "{{ pki_dir }}/api_server-server_cert/signing-config.json"
      content: |
        {
          "signing": {
            "default": {
              "expiry": "8760h"
            },
            "profiles": {
              "kubernetes": {
                "usages": ["signing", "key encipherment", "server auth", "client auth"],
                "expiry": "8760h"
              }
            }
          }
        }
      mode: 0600

  - name: Kubernetes | Control Plane | API Server | Server Certificate | build the CSRs (Certificate Signing Requests)
    copy:
      dest: "{{ pki_dir }}/api_server-server_cert/csr.json"
      content: |
        {
          "CN": "kubernetes",
          "key": {
            "algo": "rsa",
            "size": 2048
          },
          "names": [
            {
              "C": "US",
              "L": "Portland",
              "O": "Kubernetes",
              "OU": "{{ kubernetes_cluster_name }}",
              "ST": "Somewhere nice"
            }
          ]
        }
      mode: 0600

  - name: Kubernetes | Control Plane | API Server | Server Certificate | generate
    shell: |
      pushd {{ pki_dir }}/api_server-server_cert ;

      cfssl gencert \
      -ca={{ root_ca_cert_file }} \
      -ca-key={{ root_ca_key_file }} \
      -config=signing-config.json \
      -hostname=127.0.0.1,kubernetes.default,{{ kubernetes_masters | map('extract', hostvars, 'ansible_all_ipv4_addresses') | list | flatten | join(',') }} \
      -profile=kubernetes \
      csr.json | cfssljson -bare api-server

      popd ;
    args:
        executable: bash

  - name: Kubernetes | Control Plane | API Server | Server Certificate | cleanup
    file: 
      path: "{{ pki_dir }}/api_server-server_cert/{{ item }}"
      state: absent
    with_items: 
    - signing-config.json
    - csr.json
    - api-server.csr

- name: Kubernetes | Control Plane | API Server | Distribute certificates
  copy:
    src: "{{ item }}"
    dest: "{{ ansible_env.HOME }}"
    mode: 0400
  with_items:
  - "{{ root_ca_cert_file }}"
  - "{{ root_ca_key_file }}"
  - "{{ pki_dir }}/api_server-server_cert/api-server.pem"
  - "{{ pki_dir }}/api_server-server_cert/api-server-key.pem"
  when: "'masters' in group_names"
  tags:
  - distribute_certificates
  - distribute_server_certificates
  - distribute_api_server_certificate



- name: Kubernetes | Control Plane | API Server | Security | Encryption
  copy:
    dest: "{{ ansible_env.HOME }}/etcd-data-encryption-config.yaml"
    content: |
      kind: EncryptionConfig
      apiVersion: v1
      resources:
        - resources:
            - secrets
          providers:
            - aescbc:
                keys:
                  - name: key1
                    secret: "{{ etcd_data_encryption_key | b64encode }}"
            - identity: {}
  when: "'masters' in group_names"
  tags:
  - configure_api_server_secrets_encryption

- name: Kubernetes | Control Plane | API Server | Service | Create
  when: "'masters' in group_names"
  tags:
  - start_api_server
  become: yes
  copy: 
    dest: /etc/systemd/system/kube-apiserver.service
    content: |
      [Unit]
        Description=Kubernetes API Server

      [Service]
        ExecStart=/usr/bin/kube-apiserver \
          --admission-control=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \
          --advertise-address={{ ansible_eth1.ipv4.address }} \
          --allow-privileged=true \
          --apiserver-count=3 \
          --audit-log-maxage=30 \
          --audit-log-maxbackup=3 \
          --audit-log-maxsize=100 \
          --audit-log-path=/var/log/audit.log \
          --authorization-mode=Node,RBAC \
          --bind-address=0.0.0.0 \
          --client-ca-file={{ ansible_env.HOME }}/api-server.pem \
          --enable-swagger-ui=true \
          --etcd-cafile={{ ansible_env.HOME }}/{{ root_ca_cert_file | basename }} \
          --etcd-certfile={{ ansible_env.HOME }}/api-server.pem \
          --etcd-keyfile={{ ansible_env.HOME }}/api-server-key.pem \
          --etcd-servers={{ etcd_peers | map('extract', hostvars, ['ansible_eth1', 'ipv4', 'address']) | list | map('regex_replace', '^(.*)$', 'https://\1:2379') | list | join(',') }} \
          --event-ttl=1h \
          --experimental-encryption-provider-config={{ ansible_env.HOME }}/etcd-data-encryption-config.yaml \
          --insecure-bind-address=127.0.0.1 \
          --kubelet-certificate-authority={{ ansible_env.HOME }}/{{ root_ca_cert_file | basename }} \
          --kubelet-client-certificate={{ ansible_env.HOME }}/api-server.pem  \
          --kubelet-client-key={{ ansible_env.HOME }}/api-server-key.pem \
          --kubelet-https=true \
          --runtime-config=api/all \
          --service-account-key-file={{ ansible_env.HOME }}/{{ root_ca_key_file | basename }} \
          --service-cluster-ip-range=10.32.0.0/24 \
          --service-node-port-range=30000-32767 \
          --tls-cert-file={{ ansible_env.HOME }}/api-server.pem \
          --tls-private-key-file={{ ansible_env.HOME }}/api-server-key.pem \
          --v=2
        Restart=on-failure
        RestartSec=5

      [Install]
        WantedBy=multi-user.target

- name: Kubernetes | Control Plane | API Server | Service | Start
  when: "'masters' in group_names"
  tags:
  - start_api_server
  become: yes
  systemd:
    name: kube-apiserver
    enabled: yes
    state: started
    daemon_reload: yes
