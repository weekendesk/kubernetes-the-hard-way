---
- name: Root CA | create the work directory
  file:
    path: "{{ root_ca_dir }}"
    state: directory
    recurse: yes

- name: Root CA | build the CSR (Certificate Signing Request)
  copy:
    dest: "{{ root_ca_dir }}/csr.json"
    content: |
      {
        "CN": "Kubernetes",
        "key": {
          "algo": "rsa",
          "size": 2048
        },
        "names": [
          {
            "C": "US",
            "L": "Portland",
            "O": "Kubernetes",
            "OU": "CA",
            "ST": "Oregon"
          }
        ]
      }
    mode: 0600

- name: Root CA | generate
  shell: |
    pushd {{ root_ca_dir }} ;
    cfssl gencert -initca csr.json | cfssljson -bare ca ;
    popd ;
  args:
    executable: bash
    creates: "{{ root_ca_dir }}/ca-key.pem"

  
- name: Root CA | cleanup
  file: 
    path: "{{ root_ca_dir }}/{{ item }}"
    state: absent
  with_items:
  - csr.json
  - ca.csr