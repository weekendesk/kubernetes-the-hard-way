---

- name: Etcd | Download
  become: yes
  script: ./scripts/download_etcd {{ etcd3_version }}
  args:
    creates: /usr/bin/etcd
  when: "'etcd_peers' in group_names"
  tags:
  - download_etcd

- name: Etcd | Create data directory
  when: "'etcd_peers' in group_names"
  tags:
  - download_etcd
  become: yes
  file:
    dest: /var/lib/etcd
    state: directory
    recurse: yes

- name: Etcd | Cluster Member Auth | Certificate Authority
  when: "'localhost' in group_names"
  tags:
  - generate_etcd_cluster_auth_ca
  import_role:
    name: subordinate-ca
  vars:
    subordinate_ca_CN: "etcd-cluster"
    subordinate_ca_parent_ca_cert_file: "{{ root_ca_cert_file }}"
    subordinate_ca_parent_ca_key_file: "{{ root_ca_key_file }}"
    subordinate_ca_output_dir: "{{ pki_dir }}/etcd/cluster_auth/"

- name: Etcd | Client Auth | Certificate Authority
  when: "'localhost' in group_names"
  tags:
  - generate_etcd_client_auth_ca
  include_role:
    name: subordinate-ca
  vars:
    subordinate_ca_CN: "etcd-data"
    subordinate_ca_parent_ca_cert_file: "{{ root_ca_cert_file }}"
    subordinate_ca_parent_ca_key_file: "{{ root_ca_key_file }}"
    subordinate_ca_output_dir: "{{ pki_dir }}/etcd/client_auth/"


- name: Etcd | Service | Create
  when: "'etcd_peers' in group_names"
  tags:
  - start_etcd
  become: yes
  copy: 
    dest: /etc/systemd/system/etcd.service
    content: |
      [Unit]
        Description=etcd
        Documentation=https://github.com/coreos

      [Service]
        Type=notify
        ExecStart=/usr/bin/etcd \
          --name "{{ ansible_hostname }}" \
          --data-dir=/var/lib/etcd \
          --initial-cluster-token "{{ kubernetes_cluster_id }}" \
          --initial-cluster {{ etcd_peers | map('extract', hostvars, ['ansible_eth1', 'ipv4', 'address']) | list | map('regex_replace', '^(.*)$', 'https://\1:2380') | list | zip(etcd_peers) | list | map('reverse') | map('list') | map('join', '=') | list | join(',') }} \
          --initial-cluster-state new \
          --peer-client-cert-auth \
          --peer-cert-file="{{ ansible_env.HOME }}/api-server.pem" \
          --peer-key-file="{{ ansible_env.HOME }}/api-server-key.pem" \
          --peer-trusted-ca-file="{{ ansible_env.HOME }}/ca.pem" \
          --initial-advertise-peer-urls https://{{ etcd_cluster_ip_address }}:2380 \
          --listen-peer-urls https://{{ etcd_cluster_ip_address }}:2380 \
          --client-cert-auth \
          --cert-file="{{ ansible_env.HOME }}/api-server.pem" \
          --key-file="{{ ansible_env.HOME }}/api-server-key.pem" \
          --trusted-ca-file="{{ ansible_env.HOME }}/ca.pem" \
          --listen-client-urls https://{{ etcd_cluster_ip_address }}:2379,http://127.0.0.1:2379 \
          --advertise-client-urls https://{{ etcd_cluster_ip_address }}:2379
        Restart=on-failure
        RestartSec=5

      [Install]
        WantedBy=multi-user.target

- name: Etcd | Service | Start
  when: "'etcd_peers' in group_names"
  tags:
  - start_etcd
  become: yes
  systemd:
    name: etcd
    enabled: yes
    state: started
    daemon_reload: yes


