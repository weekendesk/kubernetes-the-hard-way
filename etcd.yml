---

- name: Etcd | Download
  become: yes
  script: ./scripts/download_etcd {{ etcd3_version }}
  args:
    creates: /tmp/.download_etcd
  when: "'etcd_peers' in group_names"
  tags:
  - download_etcd

- name: Etcd | Security | Encryption
  copy:
    dest: "{{ ansible_env.HOME }}/etcd-data-encryption-config.yaml"
    content: |
      kind: EncryptionConfig
      apiVersion: v1
      resources:
        - resources:
            - secrets
          providers:
            - aescbc:
                keys:
                  - name: key1
                    secret: "{{ etcd_data_encryption_key }}"
            - identity: {}
  when: "'etcd_peers' in group_names"
  tags:
  - configure_etcd_secrets_encryption_at_rest
